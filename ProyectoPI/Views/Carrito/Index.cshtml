@model List<ProyectoPI.Models.Carrito.CarritoItem>


@if (Model.Count > 0){
    <div style="background-color: white; padding: 1.5rem;border-radius: 15px;">
        <h2>Carrito de Compras</h2>
        <div id="carrito-content">
            <ul class="list-group">
                @foreach (var item in Model)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="@item.Maki.Id">
                        <div>
                            @item.Maki.Nombre
                            <span class="badge badge-primary badge-pill ml-2" id="cantidad-@item.Maki.Id">@item.Cantidad</span>
                            <span class="badge badge-info badge-pill ml-2" id="precio-unitario-@item.Maki.Id">$@item.Maki.Precio</span>
                            <span class="badge badge-success badge-pill ml-2" id="precio-total-@item.Maki.Id">$@(item.Maki.Precio * item.Cantidad)</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="decrementQuantity(@item.Maki.Id)">-</button>
                            <button class="btn btn-sm btn-outline-success" onclick="incrementQuantity(@item.Maki.Id)">+</button>
                        </div>
                    </li>
                }
            </ul>
        </div>

        <div class="mt-3">
            <div>
                <span class="font-weight-bold">Total:</span>
                <span id="total-price" class="badge badge-success badge-pill ml-2">$0.00</span>
            </div>
            <button class="btn btn-primary mt-3" id="confirmar-compra">Confirmar Compra</button>
        </div>
    </div>
}
else
{
    <div style="background-color: white;border-radius: 25px; width: 450px;margin: 0 auto;box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);padding: 1.5rem;">
        <img style="width: 250px;margin: 1rem auto; display:flex" src="~/images/carVacio.png" />
        <h3 style="text-align:center;">El carrito se encuentra vacio!!</h3>
    </div>
}




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Al cargar la página, calcula el total
    $(document).ready(function () {
        recalculateTotal();
    });

    function recalculateTotal() {
        var total = 0;

        // Recalcula el total sumando los precios totales de los elementos en el carrito
        $(".list-group-item").each(function () {
            var item = $(this);
            var itemTotalText = item.find(".badge-success").text().replace("$", ""); // Obtén el texto del elemento
            var itemTotal = parseFloat(itemTotalText);

            if (!isNaN(itemTotal)) {
                total += itemTotal;
            }
        });

        // Actualiza el elemento del monto total
        $("#total-price").text("$" + total.toFixed(2));
    }


    // Incrementa la cantidad de un producto
    function incrementQuantity(makiId) {
        $.post("/Carrito/IncrementQuantity", { makiId: makiId }, function (data) {
            if (data.success) {
                updateCarrito();
            }
        });
    }

    // Decrementa la cantidad de un producto
    function decrementQuantity(makiId) {
        $.post("/Carrito/DecrementQuantity", { makiId: makiId }, function (data) {
            if (data.success) {
                updateCarrito();
            }
        });
    }

    // Actualiza el carrito en la vista
    function updateCarrito() {
        $.get("/Carrito/UpdateCarrito", function (carritoHtml) {
            $("#carrito-content").html(carritoHtml);
            recalculateTotal();
        });
    }

    $("#confirmar-compra").click(function () {
        var total = parseFloat($("#total-price").text().replace("$", ""));

        // Recopila los detalles de los productos en el carrito
        var detallesVenta = [];
        $(".list-group-item").each(function (i) {
            var item = $(this);
            var makiId = item.data("id");
            var id = i + 1;
            var cantidad = parseInt(item.find(".badge-primary").text());
            detallesVenta.push({ MakiId: makiId, Cantidad: cantidad, Id:id });
        });
        var ventaData = {
            CodigoVenta: "",
            MontoTotal: total,
            DetalleVentas: detallesVenta
        };
        console.log(ventaData)

        $.ajax({
            url: "/api/Api/ventas/confirmarcompra",
            type: "POST",
            data: JSON.stringify(ventaData),
            contentType: "application/json; charset=utf-8",
            success: function (data, textStatus, xhr) {
                console.log("Compra confirmada con éxito", data);
                console.log("Estado de la solicitud:", textStatus);
                    Swal.fire({
                        title: 'Compra Exitosa',
                        icon: 'success',
                        showCancelButton: false,
                        showConfirmButton: false,
                        timer: 3000
                    });
                setTimeout(function () {
                    window.location.href = '/Makis/Index';  // Ajusta la ruta según tu configuración
                }, 3000);
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
                Swal.fire({
                    title: 'Error al confirmar la compra',
                    text: 'Hubo un problema al procesar la solicitud. Por favor, inténtalo nuevamente.',
                    icon: 'error',
                    showConfirmButton: true,
                });
            }
        });
    });

</script>
